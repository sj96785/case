<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>案件摘要回報 PWA</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon.svg" />

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb1d1; --text:#e8efff;
      --line:rgba(255,255,255,.10); --accent:#2563eb; --accent2:#22c55e; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(37,99,235,.18), transparent 55%),
                  radial-gradient(1000px 600px at 80% 20%, rgba(34,197,94,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:22px 16px 40px;}
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin: 8px 0 18px;
    }
    h1{font-size:22px; margin:0; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 840px){
      .grid{grid-template-columns:1fr}
    }
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    input, select, textarea, button{
      font: inherit;
    }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(12,18,34,.75);
      color: var(--text);
      outline: none;
    }
    input::placeholder, textarea::placeholder{color: rgba(159,177,209,.65)}
    textarea{min-height:92px; resize: vertical; line-height:1.55}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex: 1 1 auto}
    .tiny{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .pill input{width:auto}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(17,26,46,.55);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{border-color: rgba(255,255,255,.22)}
    button:active{transform: translateY(1px)}
    .primary{background: rgba(37,99,235,.30); border-color: rgba(37,99,235,.55)}
    .success{background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.45)}
    .danger{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.40)}
    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 18px 0 10px;
    }
    .sectionTitle h2{font-size:16px; margin:0}
    .segments{display:flex; flex-direction:column; gap:10px}
    .seg{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    }
    .segHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .segTag{font-size:12px; color:var(--muted)}
    .outWrap{margin-top:14px}
    .outWrap textarea{min-height: 240px}
    .toast{
      position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}
    .hintLine{margin-top:8px; color:var(--muted); font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>案件摘要回報</h1>
        <div class="sub">填欄位 → 產生固定格式文字 → 一鍵複製（可離線/PWA）</div>
      </div>
      <div class="pill tiny" title="離線狀態">
        <span>狀態：</span><span id="netState">檢查中…</span>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div>
          <label>案由</label>
          <select id="caseType">
            <option value="受理詐欺案">受理詐欺案</option>
            <option value="受理竊盜案">受理竊盜案</option>
            <option value="偵破竊盜案">偵破竊盜案</option>
            <option value="查獲__customTail">查獲00（00可自填）</option>
            <option value="現行犯案">現行犯案</option>
            <option value="偵破詐欺案">偵破詐欺案</option>
            <option value="打架案">打架案</option>
            <option value="糾紛案">糾紛案</option>
            <option value="__customFull">自填（可自填整個案由）</option>
          </select>
          <div class="hintLine">選「查獲00」或「自填」會出現額外輸入框。</div>
        </div>

        <div id="caseCustomBox" style="display:none;">
          <label id="caseCustomLabel">自填</label>
          <input id="caseCustom" type="text" placeholder="請輸入…" />
          <div class="hintLine" id="caseCustomHint"></div>
        </div>

        <div>
          <label id="timeLabel">發生(現)時間</label>
          <input id="timeInput" type="datetime-local" />
          <div class="row" style="margin-top:8px;">
            <label class="pill tiny" style="margin:0;">
              <input id="timeAsSeized" type="checkbox" />
              <span>標題改為「查獲時間」</span>
            </label>
          </div>
        </div>

        <div>
          <label id="locLabel">發生(現)地點</label>
          <input id="locInput" type="text" placeholder="例如：高雄市大社區明園巷37-1號" />
          <div class="row" style="margin-top:8px;">
            <label class="pill tiny" style="margin:0;">
              <input id="locAsSeized" type="checkbox" />
              <span>標題改為「查獲地點」</span>
            </label>
          </div>
        </div>

        <div style="grid-column:1 / -1;">
          <label>嫌疑人（可留白不輸出）</label>
          <input id="suspectInput" type="text" placeholder="若無不用填寫" />
          <div class="hintLine">此欄位留白 → 產出文字自動不顯示此段，後面編號會自動遞補。</div>
        </div>
      </div>

      <div class="sectionTitle">
        <h2>案情摘要</h2>
        <div class="row" style="justify-content:flex-end;">
          <label class="pill tiny" style="margin:0;">
            <input id="sumUseSub" type="checkbox" checked />
            <span>使用（ㄧ）（二）（三）分段</span>
          </label>
          <button id="sumAdd" class="success" type="button">新增段落</button>
        </div>
      </div>

      <div id="sumSegments" class="segments"></div>

      <div class="sectionTitle">
        <h2>後續處理</h2>
        <div class="row" style="justify-content:flex-end;">
          <label class="pill tiny" style="margin:0;">
            <input id="folUseSub" type="checkbox" checked />
            <span>使用（ㄧ）（二）（三）分段</span>
          </label>
          <button id="folPrefill" class="primary" type="button">帶入預設文字</button>
          <button id="folAdd" class="success" type="button">新增段落</button>
        </div>
      </div>

      <div id="folSegments" class="segments"></div>

      <div class="btnbar">
        <button id="genBtn" class="primary" type="button">產生敘述</button>
        <button id="copyBtn" class="success" type="button">複製到剪貼簿</button>
        <button id="clearBtn" class="danger" type="button">清除全部</button>
      </div>

      <div class="outWrap">
        <label>輸出結果（可直接貼到群組）</label>
        <textarea id="output" readonly class="mono" placeholder="按「產生敘述」後會出現在這裡"></textarea>
        <div class="hintLine">格式固定跨行分段；有分段時會自動加（ㄧ）（二）（三）。</div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">已複製</div>

  <script>
    // ========== PWA: 註冊 Service Worker ==========
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }

    // ========== 小工具 ==========
    const pad2 = (n) => String(n).padStart(2, "0");
    const cnNums = ["", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];

    function toROCDatetime(dtLocalValue){
      // dtLocalValue: "YYYY-MM-DDTHH:MM"
      if(!dtLocalValue) return "";
      const [d, t] = dtLocalValue.split("T");
      if(!d || !t) return "";
      const [Y, M, D] = d.split("-").map(Number);
      const [h, m] = t.split(":").map(Number);
      if(!Y || !M || !D || Number.isNaN(h) || Number.isNaN(m)) return "";
      const roc = Y - 1911;
      return `${roc}年${pad2(M)}月${pad2(D)}日${pad2(h)}時${pad2(m)}分`;
    }

    function showToast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=> el.classList.remove("show"), 1400);
    }

    function netStatus(){
      const el = document.getElementById("netState");
      const online = navigator.onLine;
      el.textContent = online ? "線上" : "離線";
      el.style.color = online ? "rgba(34,197,94,.95)" : "rgba(239,68,68,.95)";
    }
    window.addEventListener("online", netStatus);
    window.addEventListener("offline", netStatus);
    netStatus();

    // ========== 動態段落（案情摘要 / 後續處理） ==========
    function subLabel(i){
      // （一）（二）（三）…（十）
      return `（${cnNums[i] || i}）`;
    }

    function makeSegmentCard(prefix, i, onRemove){
      const wrap = document.createElement("div");
      wrap.className = "seg";
      wrap.dataset.index = String(i);

      const head = document.createElement("div");
      head.className = "segHead";

      const tag = document.createElement("div");
      tag.className = "segTag";
      tag.textContent = `段落 ${i}`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "danger";
      btn.textContent = "刪除";
      btn.style.padding = "8px 10px";
      btn.style.borderRadius = "12px";

      if(i === 1){
        btn.disabled = true;
        btn.style.opacity = "0.45";
        btn.title = "第一段不可刪除";
      }else{
        btn.addEventListener("click", () => onRemove(i));
      }

      head.appendChild(tag);
      head.appendChild(btn);

      const ta = document.createElement("textarea");
      ta.id = `${prefix}_seg_${i}`;
      ta.placeholder = i === 1 ? "請輸入內容…" : "請輸入延伸內容…";

      wrap.appendChild(head);
      wrap.appendChild(ta);
      return wrap;
    }

    function SegmentManager(containerId, prefix){
      const box = document.getElementById(containerId);
      let count = 0;

      const renumber = () => {
        [...box.querySelectorAll(".seg")].forEach((seg, idx) => {
          const n = idx + 1;
          seg.dataset.index = String(n);
          seg.querySelector(".segTag").textContent = `段落 ${n}`;
          const ta = seg.querySelector("textarea");
          ta.id = `${prefix}_seg_${n}`;

          const delBtn = seg.querySelector("button.danger");
          if(n === 1){
            delBtn.disabled = true;
            delBtn.style.opacity = "0.45";
            delBtn.title = "第一段不可刪除";
          }else{
            delBtn.disabled = false;
            delBtn.style.opacity = "1";
            delBtn.title = "";
            delBtn.onclick = null;
            delBtn.addEventListener("click", () => remove(n));
          }
        });
        count = box.querySelectorAll(".seg").length;
      };

      const add = () => {
        const newIndex = box.querySelectorAll(".seg").length + 1;
        const card = makeSegmentCard(prefix, newIndex, remove);
        box.appendChild(card);
        renumber();
      };

      const remove = (i) => {
        const segs = [...box.querySelectorAll(".seg")];
        const target = segs.find(s => Number(s.dataset.index) === i);
        if(target) target.remove();
        renumber();
      };

      const getValues = () => {
        const segs = [...box.querySelectorAll(".seg")];
        return segs.map((seg, idx) => {
          const ta = seg.querySelector("textarea");
          return (ta.value || "").trim();
        }).filter(v => v.length > 0);
      };

      const setFirstIfEmpty = (text) => {
        const first = box.querySelector("textarea");
        if(first && !first.value.trim()){
          first.value = text;
        }
      };

      const clear = () => {
        box.innerHTML = "";
        count = 0;
        add(); // always keep 1
      };

      // init with 1 segment
      add();

      return { add, remove, getValues, setFirstIfEmpty, clear };
    }

    const sumMgr = SegmentManager("sumSegments", "sum");
    const folMgr = SegmentManager("folSegments", "fol");

    document.getElementById("sumAdd").addEventListener("click", () => sumMgr.add());
    document.getElementById("folAdd").addEventListener("click", () => folMgr.add());

    document.getElementById("folPrefill").addEventListener("click", () => {
      folMgr.setFirstIfEmpty("本案依規定受理開案，案號：");
      showToast("已帶入預設文字（可自行修改）");
    });

    // ========== 案由：依選項顯示自填 ==========
    const caseType = document.getElementById("caseType");
    const caseCustomBox = document.getElementById("caseCustomBox");
    const caseCustom = document.getElementById("caseCustom");
    const caseCustomLabel = document.getElementById("caseCustomLabel");
    const caseCustomHint = document.getElementById("caseCustomHint");

    function refreshCaseCustomUI(){
      const v = caseType.value;
      if(v === "查獲__customTail"){
        caseCustomBox.style.display = "";
        caseCustomLabel.textContent = "查獲00（00自填）";
        caseCustom.placeholder = "例如：毒品、通緝犯、失聯移工…";
        caseCustomHint.textContent = "輸出會變成：查獲 + 你輸入的內容";
      }else if(v === "__customFull"){
        caseCustomBox.style.display = "";
        caseCustomLabel.textContent = "案由自填";
        caseCustom.placeholder = "例如：受理OO案 / 查獲OO / 其他…";
        caseCustomHint.textContent = "輸出會直接使用你輸入的案由";
      }else{
        caseCustomBox.style.display = "none";
        caseCustom.value = "";
      }
    }
    caseType.addEventListener("change", refreshCaseCustomUI);
    refreshCaseCustomUI();

    // ========== 標題切換 ==========
    const timeAsSeized = document.getElementById("timeAsSeized");
    const locAsSeized  = document.getElementById("locAsSeized");
    const timeLabelEl  = document.getElementById("timeLabel");
    const locLabelEl   = document.getElementById("locLabel");

    function refreshLabels(){
      timeLabelEl.textContent = timeAsSeized.checked ? "查獲時間" : "發生(現)時間";
      locLabelEl.textContent  = locAsSeized.checked  ? "查獲地點" : "發生(現)地點";
    }
    timeAsSeized.addEventListener("change", refreshLabels);
    locAsSeized.addEventListener("change", refreshLabels);
    refreshLabels();

    // ========== 產生文字 ==========
    function getCaseTitle(){
      const v = caseType.value;
      const custom = (caseCustom.value || "").trim();
      if(v === "查獲__customTail"){
        return custom ? `查獲${custom}` : "查獲";
      }
      if(v === "__customFull"){
        return custom || "";
      }
      return v;
    }

    function sectionNum(n){
      return `${cnNums[n] || n}、`;
    }

    function buildOutput(){
      const title = getCaseTitle().trim();
      const dt = toROCDatetime(document.getElementById("timeInput").value);
      const loc = (document.getElementById("locInput").value || "").trim();
      const suspect = (document.getElementById("suspectInput").value || "").trim();

      const sumUseSub = document.getElementById("sumUseSub").checked;
      const folUseSub = document.getElementById("folUseSub").checked;

      const sumSegs = sumMgr.getValues();
      const folSegs = folMgr.getValues();

      const blocks = [];

      // Header
      blocks.push("大社所報告");
      blocks.push(title ? title : ""); // empty allowed

      let n = 1;

      // 1 time
      const timeHead = timeAsSeized.checked ? "查獲時間" : "發生(現)時間";
      blocks.push(`${sectionNum(n)}${timeHead}： ${dt}${dt ? "。" : ""}`); n++;

      // 2 location
      const locHead = locAsSeized.checked ? "查獲地點" : "發生(現)地點";
      blocks.push(`${sectionNum(n)}${locHead}： ${loc}${loc ? "。" : ""}`); n++;

      // 3 suspect (optional)
      if(suspect){
        blocks.push(`${sectionNum(n)}嫌疑人： ${suspect}`); n++;
      }

      // summary
      const sumHead = `${sectionNum(n)}案情摘要：`;
      if(sumSegs.length === 0){
        blocks.push(sumHead);
      }else if(sumUseSub && sumSegs.length >= 2){
        const lines = [sumHead];
        sumSegs.forEach((s, i) => lines.push(`${subLabel(i+1)}${s}`));
        blocks.push(lines.join("\n"));
      }else if(sumUseSub && sumSegs.length === 1){
        blocks.push(`${sumHead} ${sumSegs[0]}`);
      }else{
        // no sublabels: multi lines if multiple segments
        if(sumSegs.length === 1){
          blocks.push(`${sumHead} ${sumSegs[0]}`);
        }else{
          blocks.push([sumHead, ...sumSegs].join("\n"));
        }
      }
      n++;

      // follow-up
      const folHead = `${sectionNum(n)}後續處理：`;
      if(folSegs.length === 0){
        blocks.push(folHead);
      }else if(folUseSub){
        const lines = [folHead];
        folSegs.forEach((s, i) => lines.push(`${subLabel(i+1)}${s}${s.endsWith("。") ? "" : "。"}`));
        blocks.push(lines.join("\n"));
      }else{
        if(folSegs.length === 1){
          blocks.push([folHead, folSegs[0]].join("\n"));
        }else{
          blocks.push([folHead, ...folSegs].join("\n"));
        }
      }

      // blocks join with blank lines between each major block (as you want "跨行分段")
      return blocks.filter(b => b !== null).join("\n\n").trim() + "\n";
    }

    document.getElementById("genBtn").addEventListener("click", () => {
      document.getElementById("output").value = buildOutput();
      showToast("已產生");
    });

    document.getElementById("copyBtn").addEventListener("click", async () => {
      const out = document.getElementById("output").value || buildOutput();
      document.getElementById("output").value = out;
      try{
        await navigator.clipboard.writeText(out);
        showToast("已複製到剪貼簿");
      }catch(e){
        // fallback
        const ta = document.getElementById("output");
        ta.focus(); ta.select();
        document.execCommand("copy");
        showToast("已複製（備援）");
      }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      caseType.value = "受理詐欺案";
      refreshCaseCustomUI();

      document.getElementById("timeInput").value = "";
      document.getElementById("locInput").value = "";
      document.getElementById("suspectInput").value = "";

      timeAsSeized.checked = false;
      locAsSeized.checked = false;
      refreshLabels();

      document.getElementById("sumUseSub").checked = true;
      document.getElementById("folUseSub").checked = true;

      sumMgr.clear();
      folMgr.clear();

      document.getElementById("output").value = "";
      showToast("已清除");
    });
  </script>
</body>
</html>

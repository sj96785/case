<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>案件摘要回報 PWA</title>

  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="icon.svg" />

  <style>
    :root{
      --bg:#0b1220; --card:#111a2e; --muted:#9fb1d1; --text:#e8efff;
      --line:rgba(255,255,255,.10); --accent:#2563eb; --accent2:#22c55e; --danger:#ef4444;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial, sans-serif;
      background: radial-gradient(1200px 700px at 10% 10%, rgba(37,99,235,.18), transparent 55%),
                  radial-gradient(1000px 600px at 80% 20%, rgba(34,197,94,.14), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px; margin:0 auto; padding:22px 16px 40px;}
    header{
      display:flex; align-items:flex-end; justify-content:space-between; gap:12px;
      margin: 8px 0 18px;
    }
    h1{font-size:22px; margin:0; letter-spacing:.5px}
    .sub{color:var(--muted); font-size:13px; margin-top:6px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 840px){
      .grid{grid-template-columns:1fr}
    }
    label{display:block; font-size:13px; color:var(--muted); margin:0 0 6px}
    input, select, textarea, button{ font: inherit; }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(12,18,34,.75);
      color: var(--text);
      outline: none;
    }
    input::placeholder, textarea::placeholder{color: rgba(159,177,209,.65)}
    textarea{min-height:92px; resize: vertical; line-height:1.55}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex: 1 1 auto}
    .tiny{font-size:12px; color:var(--muted)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(0,0,0,.16);
    }
    .pill input{width:auto}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    button{
      cursor:pointer;
      border:1px solid var(--line);
      background: rgba(17,26,46,.55);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      transition: transform .05s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{border-color: rgba(255,255,255,.22)}
    button:active{transform: translateY(1px)}
    .primary{background: rgba(37,99,235,.30); border-color: rgba(37,99,235,.55)}
    .success{background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.45)}
    .danger{background: rgba(239,68,68,.18); border-color: rgba(239,68,68,.40)}
    .sectionTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin: 18px 0 10px;
    }
    .sectionTitle h2{font-size:16px; margin:0}
    .segments{display:flex; flex-direction:column; gap:10px}
    .seg{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(0,0,0,.10);
    }
    .segHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .segTag{font-size:12px; color:var(--muted)}
    .outWrap{margin-top:14px}
    .outWrap textarea{min-height: 260px}
    .toast{
      position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity: 0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px)}
    .hintLine{margin-top:8px; color:var(--muted); font-size:12px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;}
    .divider{
      height:1px; background: var(--line); margin:16px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>案件摘要回報</h1>
        <div class="sub"></div>
      </div>
</header>

    <div class="card">
      <div class="grid">
        <div>
          <label>案由</label>
          <select id="caseType">
            <option value="受理詐欺案">受理詐欺案</option>
            <option value="受理竊盜案">受理竊盜案</option>
            <option value="偵破竊盜案">偵破竊盜案</option>
            <option value="查獲__customTail">查獲現行犯(案類自填)</option>
            <option value="偵破詐欺案">偵破詐欺案</option>
            <option value="打架案">打架案</option>
            <option value="糾紛案">糾紛案</option>
            <option value="__fire">火災案（初報/續報/結報）</option>
            <option value="__customFull">自填（可自填整個案由）</option>
          </select>
          <div class="hintLine" id="caseHint"></div>
        </div>

        <div id="caseCustomBox" style="display:none;">
          <label id="caseCustomLabel">自填</label>
          <input id="caseCustom" type="text" placeholder="請輸入…" />
          <div class="hintLine" id="caseCustomHint"></div>
        </div>

        <!-- 火災案：初報/續報/結報 -->
        <div id="fireReportTypeBox" style="display:none;">
          <label>火災案報告類型（可複選）</label>
          <div class="row">
            <label class="pill tiny" style="margin:0;"><input id="fireTypeInit" type="checkbox" checked /><span>初報</span></label>
            <label class="pill tiny" style="margin:0;"><input id="fireTypeFollow" type="checkbox" /><span>續報</span></label>
            <label class="pill tiny" style="margin:0;"><input id="fireTypeFinal" type="checkbox" /><span>結報</span></label>
          </div>
          <div class="hintLine">輸出會顯示在「大社所報告（…）」括號內，例如（續報）或（初報、結報）。</div>
        </div>

        <div>
          <label id="timeLabel">發生(現)時間</label>
          <input id="timeInput" type="datetime-local" />
          <div class="row" style="margin-top:8px;" id="timeToggleRow">
            <label class="pill tiny" style="margin:0;">
              <input id="timeAsSeized" type="checkbox" />
              <span>標題改為「查獲時間」</span>
            </label>
          </div>
        </div>

        <div>
          <label id="locLabel">發生(現)地點</label>
          <input id="locInput" type="text" placeholder="例如：高雄市大社區明園巷37-1號" />
          <div class="row" style="margin-top:8px;" id="locToggleRow">
            <label class="pill tiny" style="margin:0;">
              <input id="locAsSeized" type="checkbox" />
              <span>標題改為「查獲地點」</span>
            </label>
          </div>
        </div>

        <div id="suspectBox" style="grid-column:1 / -1;">
          <label>嫌疑人（可留白不輸出）</label>
          <input id="suspectInput" type="text" placeholder="若無不用填寫" />
</div>

        <div style="grid-column:1 / -1;">
          <label id="seizedByLabel">查獲人員（可留白不輸出）</label>
          <input id="seizedByInput" type="text" placeholder="若無不用填寫" />
          <div class="hintLine" id="seizedByHint" style="display:none"></div>
        </div>
      </div>

      <div class="sectionTitle" id="sumTitle">
        <h2 id="sumTitleText">案情摘要</h2>
        <div class="row" style="justify-content:flex-end;">
          <label class="pill tiny" style="margin:0;">
            <input id="sumUseSub" type="checkbox" />
            <span>使用（ㄧ）（二）（三）分段</span>
          </label>
          <button id="sumAdd" class="success" type="button">新增段落</button>
        </div>
      </div>

      <div id="sumSegments" class="segments"></div>

      <!-- 一般案件：後續處理 -->
      <div id="followSection">
        <div class="sectionTitle">
          <h2>後續處理</h2>
          <div class="row" style="justify-content:flex-end;">
            <label class="pill tiny" style="margin:0;">
              <input id="folUseSub" type="checkbox" />
              <span>使用（ㄧ）（二）（三）分段</span>
            </label>
            <button id="folPrefill" class="primary" type="button">帶入預設文字</button>
            <button id="folAdd" class="success" type="button">新增段落</button>
          </div>
        </div>

        <div id="folSegments" class="segments"></div>
      </div>

      <!-- 火災案：額外欄位 -->
      <div id="fireExtras" style="display:none;">
        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0;">
          <h2>火災案專用欄位</h2>
          <div class="tiny">以下 3 項會依選項自動輸出為（交通／記者／處置情形）段落。</div>
        </div>

        <div class="grid">
          <div>
            <label>交通狀況（選項）</label>
            <select id="fireTraffic">
              <option value="現場交通順暢，無阻塞情事。">現場交通順暢，無阻塞情事。</option>
              <option value="現場由本所員警指揮交通。">現場由本所員警指揮交通。</option>
            </select>
          </div>

          <div>
            <label>記者到場（選項）</label>
            <select id="fireMedia">
              <option value="none">現場無記者到場</option>
              <option value="some">現場有00台記者到場（00自填）</option>
            </select>
            <div style="margin-top:10px; display:none;" id="fireMediaDetailBox">
              <label class="tiny" style="margin:0 0 6px;">00內容（台數或電視台）</label>
              <input id="fireMediaDetail" type="text" placeholder="例如：3／TVBS、中天、三立" />
            </div>
          </div>

          <div style="grid-column:1 / -1;">
            <label>處置情形（選項）</label>
            <select id="fireDisposition">
              <option value="現場協助交管">現場協助交管</option>
              <option value="custom">自填</option>
            </select>
            <div style="margin-top:10px; display:none;" id="fireDispositionDetailBox">
              <label class="tiny" style="margin:0 0 6px;">自填內容</label>
              <input id="fireDispositionDetail" type="text" placeholder="例如：現場協助交管、疏導人群、管制出入口…" />
            </div>
          </div>
        </div>
      </div>

      <div class="btnbar">
        <button id="genBtn" class="primary" type="button">產生敘述</button>
        <button id="copyBtn" class="success" type="button">複製到剪貼簿</button>
        <button id="clearBtn" class="danger" type="button">清除全部</button>
      </div>

      <div class="outWrap">
        <label>輸出結果</label>
        <textarea id="output" readonly class="mono" placeholder="按「產生敘述」後會出現在這裡"></textarea>
        <div class="hintLine"></div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">已複製</div>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
      });
    }

    const pad2 = (n) => String(n).padStart(2, "0");
    const cnNums = ["", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
    const fireNums = ["ㄧ","二","三","四","五","六","七","八","九","十"];

    function toROCDatetime(dtLocalValue){
      if(!dtLocalValue) return "";
      const parts = dtLocalValue.split("T");
      if(parts.length !== 2) return "";
      const d = parts[0], t = parts[1];
      const dParts = d.split("-").map(Number);
      const tParts = t.split(":").map(Number);
      if(dParts.length !== 3 || tParts.length < 2) return "";
      const Y = dParts[0], M = dParts[1], D = dParts[2];
      const h = tParts[0], m = tParts[1];
      if(!Y || !M || !D || Number.isNaN(h) || Number.isNaN(m)) return "";
      const roc = Y - 1911;
      return `${roc}年${pad2(M)}月${pad2(D)}日${pad2(h)}時${pad2(m)}分`;
    }

    function showToast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=> el.classList.remove("show"), 1400);
    }

    function netStatus(){
      const el = document.getElementById("netState");
      if(!el) return;
      const online = navigator.onLine;
      el.textContent = online ? "線上" : "離線";
      el.style.color = online ? "rgba(34,197,94,.95)" : "rgba(239,68,68,.95)";
    }
    window.addEventListener("online", netStatus);
    window.addEventListener("offline", netStatus);
    netStatus();

    function subLabel(i){ return `（${cnNums[i] || i}）`; }

    function makeSegmentCard(prefix, i, onRemove){
      const wrap = document.createElement("div");
      wrap.className = "seg";
      wrap.dataset.index = String(i);

      const head = document.createElement("div");
      head.className = "segHead";

      const tag = document.createElement("div");
      tag.className = "segTag";
      tag.textContent = `段落 ${i}`;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "danger";
      btn.textContent = "刪除";
      btn.style.padding = "8px 10px";
      btn.style.borderRadius = "12px";

      if(i === 1){
        btn.disabled = true;
        btn.style.opacity = "0.45";
        btn.title = "第一段不可刪除";
      }else{
        btn.addEventListener("click", () => onRemove(i));
      }

      head.appendChild(tag);
      head.appendChild(btn);

      const ta = document.createElement("textarea");
      ta.id = `${prefix}_seg_${i}`;
      ta.placeholder = i === 1 ? "請輸入內容…" : "請輸入延伸內容…";

      wrap.appendChild(head);
      wrap.appendChild(ta);
      return wrap;
    }

    function SegmentManager(containerId, prefix){
      const box = document.getElementById(containerId);

      const renumber = () => {
        [...box.querySelectorAll(".seg")].forEach((seg, idx) => {
          const n = idx + 1;
          seg.dataset.index = String(n);
          seg.querySelector(".segTag").textContent = `段落 ${n}`;
          const ta = seg.querySelector("textarea");
          ta.id = `${prefix}_seg_${n}`;

          const delBtn = seg.querySelector("button.danger");
          if(n === 1){
            delBtn.disabled = true;
            delBtn.style.opacity = "0.45";
            delBtn.title = "第一段不可刪除";
          }else{
            delBtn.disabled = false;
            delBtn.style.opacity = "1";
            delBtn.title = "";
            delBtn.onclick = null;
            delBtn.addEventListener("click", () => remove(n));
          }
        });
      };

      const add = () => {
        const newIndex = box.querySelectorAll(".seg").length + 1;
        const card = makeSegmentCard(prefix, newIndex, remove);
        box.appendChild(card);
        renumber();
      };

      const remove = (i) => {
        const segs = [...box.querySelectorAll(".seg")];
        const target = segs.find(s => Number(s.dataset.index) === i);
        if(target) target.remove();
        renumber();
      };

      const getValues = () => {
        const segs = [...box.querySelectorAll(".seg")];
        return segs.map((seg) => (seg.querySelector("textarea").value || "").trim())
                   .filter(v => v.length > 0);
      };

      const setFirstIfEmpty = (text) => {
        const first = box.querySelector("textarea");
        if(first && !first.value.trim()) first.value = text;
      };

      const clear = () => {
        box.innerHTML = "";
        add();
      };

      add();
      return { add, remove, getValues, setFirstIfEmpty, clear };
    }

    const sumMgr = SegmentManager("sumSegments", "sum");
    const folMgr = SegmentManager("folSegments", "fol");

    document.getElementById("sumAdd").addEventListener("click", () => sumMgr.add());
    document.getElementById("folAdd").addEventListener("click", () => folMgr.add());

    document.getElementById("folPrefill").addEventListener("click", () => {
      folMgr.setFirstIfEmpty("本案依規定受理開案，案號：");
      showToast("已帶入預設文字（可自行修改）");
    });

    // ========== 火災案額外欄位互動 ==========
    const fireMedia = document.getElementById("fireMedia");
    const fireMediaDetailBox = document.getElementById("fireMediaDetailBox");
    const fireDisposition = document.getElementById("fireDisposition");
    const fireDispositionDetailBox = document.getElementById("fireDispositionDetailBox");

    function refreshFireExtras(){
      fireMediaDetailBox.style.display = (fireMedia.value === "some") ? "" : "none";
      fireDispositionDetailBox.style.display = (fireDisposition.value === "custom") ? "" : "none";
    }
    fireMedia.addEventListener("change", refreshFireExtras);
    fireDisposition.addEventListener("change", refreshFireExtras);
    refreshFireExtras();

    // ========== 案由：依選項顯示自填/切換火災案 UI ==========
    const caseType = document.getElementById("caseType");
    const caseCustomBox = document.getElementById("caseCustomBox");
    const caseCustom = document.getElementById("caseCustom");
    const caseCustomLabel = document.getElementById("caseCustomLabel");
    const caseCustomHint = document.getElementById("caseCustomHint");

    const fireReportTypeBox = document.getElementById("fireReportTypeBox");
    const followSection = document.getElementById("followSection");
    const fireExtras = document.getElementById("fireExtras");

    const timeLabelEl  = document.getElementById("timeLabel");
    const locLabelEl   = document.getElementById("locLabel");
    const timeToggleRow = document.getElementById("timeToggleRow");
    const locToggleRow = document.getElementById("locToggleRow");
    const suspectBox = document.getElementById("suspectBox");

    const seizedByLabel = document.getElementById("seizedByLabel");
    const seizedByHint = document.getElementById("seizedByHint");

    const timeAsSeized = document.getElementById("timeAsSeized");
    const locAsSeized  = document.getElementById("locAsSeized");

    function isFireMode(){ return caseType.value === "__fire"; }

    function refreshCaseCustomUI(){
      const v = caseType.value;

      // custom fields (non-fire)
      if(v === "查獲__customTail"){
        caseCustomBox.style.display = "";
        caseCustomLabel.textContent = "案類";
        caseCustom.placeholder = "例如：毒品、通緝犯、失聯移工…";
        caseCustomHint.textContent = "輸出會變成：查獲 + 你輸入的內容 + 現行犯案";
      }else if(v === "__customFull"){
        caseCustomBox.style.display = "";
        caseCustomLabel.textContent = "案由自填";
        caseCustom.placeholder = "例如：受理OO案 / 查獲OO / 其他…";
        caseCustomHint.textContent = "輸出會直接使用你輸入的案由";
      }else{
        caseCustomBox.style.display = "none";
        if(v !== "__customFull" && v !== "查獲__customTail") caseCustom.value = "";
      }

      // fire mode switch
      const fire = (v === "__fire");
      fireReportTypeBox.style.display = fire ? "" : "none";
      fireExtras.style.display = fire ? "" : "none";
      followSection.style.display = fire ? "none" : "";

      // labels & toggles
      if(fire){
        timeLabelEl.textContent = "通報時間";
        locLabelEl.textContent = "發生地點";
        timeToggleRow.style.display = "none";
        locToggleRow.style.display = "none";
        timeAsSeized.checked = false;
        locAsSeized.checked = false;

        suspectBox.style.display = "none";
        seizedByLabel.textContent = "現場處理員警（可留白不輸出）";
        document.getElementById("seizedByInput").placeholder = "例如：巡佐許允騰、警員褚克強";
        seizedByHint.textContent = "留白則可不輸出；若有填寫，會依序插入「現場處理員警」段落並自動編號。";
      }else{
        timeToggleRow.style.display = "";
        locToggleRow.style.display = "";
        timeLabelEl.textContent = timeAsSeized.checked ? "查獲時間" : "發生(現)時間";
        locLabelEl.textContent  = locAsSeized.checked  ? "查獲地點" : "發生(現)地點";
        suspectBox.style.display = "";

        seizedByLabel.textContent = "查獲人員（可留白不輸出）";
        document.getElementById("seizedByInput").placeholder = "若無不用填寫";
        seizedByHint.textContent = "留白則不輸出；若有填寫，會在最後新增一段（五/六…）。";
      }
    }
    caseType.addEventListener("change", refreshCaseCustomUI);
    refreshCaseCustomUI();

    // title toggles for non-fire
    function refreshLabels(){
      if(isFireMode()) return; // fire labels fixed
      timeLabelEl.textContent = timeAsSeized.checked ? "查獲時間" : "發生(現)時間";
      locLabelEl.textContent  = locAsSeized.checked  ? "查獲地點" : "發生(現)地點";
    }
    timeAsSeized.addEventListener("change", refreshLabels);
    locAsSeized.addEventListener("change", refreshLabels);
    refreshLabels();

    function getCaseTitle(){
      const v = caseType.value;
      const custom = (caseCustom.value || "").trim();
      if(v === "查獲__customTail") return custom ? `查獲${custom}現行犯案` : "查獲現行犯案";
      if(v === "__customFull") return custom || "";
      if(v === "__fire") return "火災案";
      return v;
    }

    function sectionNum(n){ return `${cnNums[n] || n}、`; }
    function fireSectionNum(n){ return `${fireNums[n-1] || n}、`; }
    function ensureFullStop(s){ return s && !s.endsWith("。") ? (s + "。") : s; }

    function getFireReportSuffix(){
      const parts = [];
      if(document.getElementById("fireTypeInit").checked) parts.push("初報");
      if(document.getElementById("fireTypeFollow").checked) parts.push("續報");
      if(document.getElementById("fireTypeFinal").checked) parts.push("結報");
      if(parts.length === 0) return "";
      return "（" + parts.join("、") + "）";
    }

    function buildNormalOutput(){
      const title = getCaseTitle().trim();
      const dt = toROCDatetime(document.getElementById("timeInput").value);
      const loc = (document.getElementById("locInput").value || "").trim();
      const suspect = (document.getElementById("suspectInput").value || "").trim();
      const seizedBy = (document.getElementById("seizedByInput").value || "").trim();

      const sumUseSub = document.getElementById("sumUseSub").checked;
      const folUseSub = document.getElementById("folUseSub").checked;

      const sumSegs = sumMgr.getValues();
      const folSegs = folMgr.getValues();

      const lines = [];
      lines.push("大社所報告");
      if(title) lines.push(title);

      let n = 1;

      const timeHead = timeAsSeized.checked ? "查獲時間" : "發生(現)時間";
      lines.push(`${sectionNum(n)}${timeHead}： ${dt}${dt ? "。" : ""}`); n++;

      const locHead = locAsSeized.checked ? "查獲地點" : "發生(現)地點";
      lines.push(`${sectionNum(n)}${locHead}： ${loc}${loc ? "。" : ""}`); n++;

      if(suspect){
        lines.push(`${sectionNum(n)}嫌疑人： ${suspect}`); n++;
      }

      
      const sumHead = `${sectionNum(n)}案情摘要：`;
      if(sumSegs.length === 0){
        lines.push(sumHead);
      }else if(sumSegs.length >= 2){
        // 有新增段落時：強制（ㄧ）（二）並換行
        lines.push(sumHead);
        sumSegs.forEach((s, i) => lines.push(`${subLabel(i+1)}${s}`));
      }else{
        // 只有一段時：依「是否用段落」決定格式
        if(sumUseSub){
          lines.push(sumHead);
          lines.push(`${subLabel(1)}${sumSegs[0]}`);
        }else{
          lines.push(`${sumHead} ${sumSegs[0]}`);
        }
      }
      n++;


      if(folSegs.length > 0){
        const folHead = `${sectionNum(n)}後續處理：`;
        if(folSegs.length >= 2){
          // 有新增段落時：強制（ㄧ）（二）並換行
          lines.push(folHead);
          folSegs.forEach((s, i) => lines.push(`${subLabel(i+1)}${ensureFullStop(s)}`));
        }else{
          // 只有一段時：依「是否用段落」決定格式
          if(folUseSub){
            lines.push(folHead);
            lines.push(`${subLabel(1)}${ensureFullStop(folSegs[0])}`);
          }else{
            lines.push(`${folHead} ${folSegs[0]}`.trimEnd());
          }
        }
        n++;
      }

      if(seizedBy){
        lines.push(`${sectionNum(n)}查獲人員： ${seizedBy}。`);
      }

      return lines.join("\n").trim() + "\n";
    }

    function buildFireOutput(){
      const dt = toROCDatetime(document.getElementById("timeInput").value);
      const loc = (document.getElementById("locInput").value || "").trim();
      const officer = (document.getElementById("seizedByInput").value || "").trim();

      const sumUseSub = document.getElementById("sumUseSub").checked;
      const sumSegs = sumMgr.getValues();

      const trafficText = document.getElementById("fireTraffic").value;

      const mediaMode = document.getElementById("fireMedia").value;
      const mediaDetail = (document.getElementById("fireMediaDetail").value || "").trim();
      let mediaText = "現場無記者到場";
      if(mediaMode === "some"){
        mediaText = mediaDetail ? `現場有${mediaDetail}台記者到場` : "現場有00台記者到場";
      }

      const dispMode = document.getElementById("fireDisposition").value;
      const dispDetail = (document.getElementById("fireDispositionDetail").value || "").trim();
      let dispText = "現場協助交管";
      if(dispMode === "custom") dispText = dispDetail || "";

      const lines = [];
      lines.push(`大社所報告${getFireReportSuffix()}`);

      let n = 1;
      lines.push(`${fireSectionNum(n)}案由：火災案`); n++;
      lines.push(`${fireSectionNum(n)}通報時間：${dt}`); n++;
      lines.push(`${fireSectionNum(n)}發生地點：${loc}`); n++;

      if(officer){
        lines.push(`${fireSectionNum(n)}現場處理員警：${officer}`); n++;
      }


      // summary
      const fireSumHead = `${fireSectionNum(n)}案情摘要：`;
      if(sumSegs.length === 0){
        lines.push(fireSumHead); n++;
      }else if(sumSegs.length >= 2){
        lines.push(fireSumHead);
        sumSegs.forEach((s, i) => lines.push(`${subLabel(i+1)}${s}`));
        n++;
      }else{
        if(sumUseSub){
          lines.push(fireSumHead);
          lines.push(`${subLabel(1)}${sumSegs[0]}`);
        }else{
          lines.push(`${fireSumHead}${sumSegs[0]}`);
        }
        n++;
      }
// traffic
      lines.push(`${fireSectionNum(n)}${trafficText}`); n++;

      // media
      lines.push(`${fireSectionNum(n)}${mediaText}`); n++;

      // disposition
      lines.push(`${fireSectionNum(n)}處置情形：${dispText}`); n++;

      return lines.join("\n").trim() + "\n";
    }

    function buildOutput(){
      return isFireMode() ? buildFireOutput() : buildNormalOutput();
    }

    document.getElementById("genBtn").addEventListener("click", () => {
      document.getElementById("output").value = buildOutput();
      showToast("已產生");
    });

    document.getElementById("copyBtn").addEventListener("click", async () => {
      const out = document.getElementById("output").value || buildOutput();
      document.getElementById("output").value = out;
      try{
        await navigator.clipboard.writeText(out);
        showToast("已複製到剪貼簿");
      }catch(e){
        const ta = document.getElementById("output");
        ta.focus(); ta.select();
        document.execCommand("copy");
        showToast("已複製（備援）");
      }
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      caseType.value = "受理詐欺案";
      caseCustom.value = "";
      refreshCaseCustomUI();

      document.getElementById("timeInput").value = "";
      document.getElementById("locInput").value = "";
      document.getElementById("suspectInput").value = "";
      document.getElementById("seizedByInput").value = "";

      timeAsSeized.checked = false;
      locAsSeized.checked = false;
      refreshLabels();

      document.getElementById("sumUseSub").checked = false;
      document.getElementById("folUseSub").checked = false;

      // fire defaults
      document.getElementById("fireTypeInit").checked = true;
      document.getElementById("fireTypeFollow").checked = false;
      document.getElementById("fireTypeFinal").checked = false;
      document.getElementById("fireTraffic").value = "現場交通順暢，無阻塞情事。";
      document.getElementById("fireMedia").value = "none";
      document.getElementById("fireMediaDetail").value = "";
      document.getElementById("fireDisposition").value = "現場協助交管";
      document.getElementById("fireDispositionDetail").value = "";
      refreshFireExtras();

      sumMgr.clear();
      folMgr.clear();

      document.getElementById("output").value = "";
      showToast("已清除");
    });
  </script>
</body>
</html>
